@model IEnumerable<KMSI_Projects.Models.Student>

@{
    ViewData["Title"] = "Students";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Students Management</h4>
                        <button type="button" class="btn btn-primary" onclick="openCreateModal()" data-bs-toggle="modal" data-bs-target="#studentModal">
                            <i class="fas fa-plus me-2"></i>Add New Student
                        </button>
                    </div>

                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="table-responsive">
                        <table class="table table-striped" id="studentTable">
                            <thead>
                                <tr>
                                    <th>Student Code</th>
                                    <th>Full Name</th>
                                    <th>Company</th>
                                    <th>Site</th>
                                    <th>Current Grade</th>
                                    <th>Assigned Teacher</th>
                                    <th>Registration Date</th>
                                    <th>Status</th>
                                    <th>Contact</th>
                                    <th width="120">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var student in Model)
                                {
                                    <tr>
                                        <td>@student.StudentCode</td>
                                        <td>@student.FullName</td>
                                        <td>@student.Company?.CompanyName</td>
                                        <td>@student.Site?.SiteName</td>
                                        <td>@(student.CurrentGrade?.GradeName ?? "Not assigned")</td>
                                        <td>@(student.AssignedTeacher?.User?.FirstName + " " + student.AssignedTeacher?.User?.LastName ?? "Not assigned")</td>
                                        <td>@student.RegistrationDate.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            <span class="badge bg-@(student.IsActive ? "success" : "danger")">
                                                @student.Status
                                            </span>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(student.Phone) || !string.IsNullOrEmpty(student.Email))
                                            {
                                                <div class="d-flex flex-column">
                                                    @if (!string.IsNullOrEmpty(student.Phone))
                                                    {
                                                        <small><i class="fas fa-phone text-muted me-1"></i>@student.Phone</small>
                                                    }
                                                    @if (!string.IsNullOrEmpty(student.Email))
                                                    {
                                                        <small><i class="fas fa-envelope text-muted me-1"></i>@student.Email</small>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">No contact</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-info" onclick="viewDetails(@student.StudentId)" data-bs-toggle="modal" data-bs-target="#detailsModal" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openEditModal(@student.StudentId)" data-bs-toggle="modal" data-bs-target="#studentModal" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteStudent(@student.StudentId)" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Modal -->
<div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentModalLabel">Add New Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" id="studentId" name="StudentId" value="0">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="studentCode" class="form-label">Student Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="studentCode" name="StudentCode"
                                   placeholder="e.g., KMI-2401-01530" maxlength="20" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="registrationDate" class="form-label">Registration Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="registrationDate" name="RegistrationDate" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="firstName" name="FirstName"
                                   placeholder="First Name" maxlength="50" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="lastName" name="LastName"
                                   placeholder="Last Name" maxlength="50" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="DateOfBirth">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" name="Gender">
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="Phone"
                                   placeholder="Phone Number" maxlength="20">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="Email"
                                   placeholder="email@example.com" maxlength="100">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="parentEmail" class="form-label">Parent Email</label>
                            <input type="email" class="form-control" id="parentEmail" name="ParentEmail"
                                   placeholder="parent@example.com" maxlength="100">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="status" name="Status" required>
                                <option value="Pending">Pending</option>
                                <option value="Active" selected>Active</option>
                                <option value="Trial">Trial</option>
                                <option value="Completed">Completed</option>
                                <option value="Dropped">Dropped</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyId" class="form-label">Company <span class="text-danger">*</span></label>
                            <select class="form-select" id="companyId" name="CompanyId" required onchange="loadSitesByCompany(this.value)">
                                <option value="">Select Company</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="siteId" class="form-label">Site <span class="text-danger">*</span></label>
                            <select class="form-select" id="siteId" name="SiteId" required>
                                <option value="">Select Site</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="currentGradeId" class="form-label">Current Grade</label>
                            <select class="form-select" id="currentGradeId" name="CurrentGradeId">
                                <option value="">Select Grade</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="assignedTeacherId" class="form-label">Assigned Teacher</label>
                            <select class="form-select" id="assignedTeacherId" name="AssignedTeacherId">
                                <option value="">Select Teacher</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="Notes" rows="3"
                                  placeholder="Additional notes about the student" maxlength="1000"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveButton" onclick="KMSI.Student.submitForm()">
                    <i class="fas fa-save me-2"></i>Save Student
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Details content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ===================================================================
        // PRODUCTION-READY JAVASCRIPT untuk KMSI Student Module
        // ===================================================================

        // Extend existing KMSI object
        KMSI.Student = {
            // Initialize module
            init: function() {
                this.isEditMode = false;
                this.studentTable = null;
                this.bindEvents();
                this.initializeDataTable();
            },

            // Bind event handlers
            bindEvents: function() {
                const self = this;

                // Student code to uppercase
                $(document).on('input', '#studentCode', function() {
                    this.value = this.value.toUpperCase();
                });

                // Form submission
                $(document).on('submit', '#studentForm', function(e) {
                    e.preventDefault();
                    self.submitForm();
                });

                // Modal events
                $('#studentModal').on('hidden.bs.modal', function() {
                    self.resetForm();
                });
            },

            // Initialize DataTable
            initializeDataTable: function() {
                try {
                    if ($.fn.DataTable && $('#studentTable').length) {
                        this.studentTable = KMSI.initDataTable('#studentTable', {
                            order: [[1, 'asc']], // Sort by student name
                            columnDefs: [
                                { targets: [9], orderable: false } // Actions column not sortable
                            ]
                        });
                        console.log('Student DataTable initialized successfully');
                    }
                } catch (error) {
                    console.error('Error initializing DataTable:', error);
                    KMSI.showToast('Error initializing table. Some features may not work properly.', 'warning');
                }
            },

            // Reset form
            resetForm: function() {
                try {
                    $('#studentForm')[0].reset();
                    $('#studentId').val('0');
                    $('.form-control, .form-select').removeClass('is-invalid');
                    $('.invalid-feedback').hide();

                    // Clear dropdown options except default
                    $('#companyId option:not(:first)').remove();
                    $('#siteId option:not(:first)').remove();
                    $('#currentGradeId option:not(:first)').remove();
                    $('#assignedTeacherId option:not(:first)').remove();

                    // Set default registration date to today
                    $('#registrationDate').val(new Date().toISOString().split('T')[0]);
                } catch (error) {
                    console.error('Error resetting form:', error);
                }
            },

            // Submit form
            submitForm: function() {
                if (!this.validateForm()) {
                    return;
                }

                try {
                    const formData = $('#studentForm').serialize();
                    const url = this.isEditMode ? 
                        KMSI.Config.buildUrl('/Student/Edit') : 
                        KMSI.Config.buildUrl('/Student/Create');

                    $('#saveButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

                    $.post(url, formData)
                        .done(function(response) {
                            if (response.success) {
                                KMSI.showToast(response.message || 'Student saved successfully!', 'success');
                                $('#studentModal').modal('hide');
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                KMSI.showToast(response.message || 'Failed to save student', 'error');
                            }
                        })
                        .fail(function(xhr, status, error) {
                            let message = 'Failed to save student. ';

                            if (status === 'timeout') {
                                message += 'Request timed out.';
                            } else if (xhr.status === 400) {
                                message += 'Invalid data provided.';
                            } else if (xhr.status === 401 || xhr.status === 403) {
                                message += 'You are not authorized to perform this action.';
                            } else if (xhr.status >= 500) {
                                message += 'Server error occurred.';
                            } else {
                                message += 'Please check your connection and try again.';
                            }

                            KMSI.showToast(message, 'error');
                            console.error('Student save error:', xhr, status, error);
                        })
                        .always(function() {
                            $('#saveButton').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save Student');
                        });

                } catch (error) {
                    console.error('Error in submitForm:', error);
                    KMSI.showToast('An unexpected error occurred. Please try again.', 'error');
                }
            },

            // Validate form
            validateForm: function() {
                var isValid = true;

                // Clear previous validation
                $('.form-control, .form-select').removeClass('is-invalid');
                $('.invalid-feedback').hide();

                // Required field validation
                var requiredFields = ['studentCode', 'firstName', 'lastName', 'registrationDate', 'status', 'companyId', 'siteId'];

                requiredFields.forEach(function(field) {
                    var element = $('#' + field);
                    if (!element.val()) {
                        element.addClass('is-invalid');
                        element.siblings('.invalid-feedback').text('This field is required').show();
                        isValid = false;
                    }
                });

                // Student code validation
                var studentCode = $('#studentCode').val();
                if (studentCode && !/^[A-Z0-9-]+$/.test(studentCode)) {
                    $('#studentCode').addClass('is-invalid');
                    $('#studentCode').siblings('.invalid-feedback').text('Student code must contain only uppercase letters, numbers, and hyphens').show();
                    isValid = false;
                }

                // Email validation
                var email = $('#email').val();
                if (email && !/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email)) {
                    $('#email').addClass('is-invalid');
                    $('#email').siblings('.invalid-feedback').text('Please enter a valid email address').show();
                    isValid = false;
                }

                // Parent email validation
                var parentEmail = $('#parentEmail').val();
                if (parentEmail && !/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(parentEmail)) {
                    $('#parentEmail').addClass('is-invalid');
                    $('#parentEmail').siblings('.invalid-feedback').text('Please enter a valid email address').show();
                    isValid = false;
                }

                return isValid;
            }
        };

        // Global functions untuk onclick handlers
        function openCreateModal() {
            try {
                KMSI.Student.isEditMode = false;
                $('#studentModalLabel').text('Add New Student');
                KMSI.Student.resetForm();
                loadCreateFormData();
            } catch (error) {
                console.error('Error opening create modal:', error);
                KMSI.showToast('Error opening form. Please try again.', 'error');
            }
        }

        function openEditModal(id) {
            try {
                KMSI.Student.isEditMode = true;
                $('#studentModalLabel').text('Edit Student');
                KMSI.Student.resetForm();
                loadEditFormData(id);
            } catch (error) {
                console.error('Error opening edit modal:', error);
                KMSI.showToast('Error opening edit form. Please try again.', 'error');
            }
        }

        function loadCreateFormData() {
            $.get(KMSI.Config.buildUrl('/Student/GetCreateForm'))
                .done(function(response) {
                    if (response.success) {
                        // Populate companies dropdown
                        $.each(response.companies, function(index, company) {
                            $('#companyId').append($('<option></option>').val(company.companyId).text(company.companyName));
                        });

                        // Populate grades dropdown
                        $.each(response.grades, function(index, grade) {
                            $('#currentGradeId').append($('<option></option>').val(grade.gradeId).text(grade.gradeName));
                        });

                        // Populate teachers dropdown
                        $.each(response.teachers, function(index, teacher) {
                            $('#assignedTeacherId').append($('<option></option>').val(teacher.teacherId).text(teacher.teacherName));
                        });

                        $('#studentModal').modal('show');
                    } else {
                        KMSI.showToast(response.message || 'Failed to load form data', 'error');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Create form data request failed:', xhr, status, error);
                    KMSI.showToast('Failed to load form data', 'error');
                });
        }

        function loadEditFormData(id) {
            $.get(KMSI.Config.buildUrl('/Student/GetEditForm/' + id))
                .done(function(response) {
                    if (response.success) {
                        var student = response.student;

                        // Populate form fields
                        $('#studentId').val(student.studentId);
                        $('#studentCode').val(student.studentCode);
                        $('#firstName').val(student.firstName);
                        $('#lastName').val(student.lastName);
                        $('#dateOfBirth').val(student.dateOfBirth ? student.dateOfBirth.split('T')[0] : '');
                        $('#gender').val(student.gender || '');
                        $('#phone').val(student.phone || '');
                        $('#email').val(student.email || '');
                        $('#parentEmail').val(student.parentEmail || '');
                        $('#registrationDate').val(student.registrationDate.split('T')[0]);
                        $('#status').val(student.status);
                        $('#notes').val(student.notes || '');

                        // Populate companies dropdown
                        $.each(response.companies, function(index, company) {
                            var selected = company.companyId === student.companyId ? 'selected' : '';
                            $('#companyId').append($('<option ' + selected + '></option>').val(company.companyId).text(company.companyName));
                        });

                        // Load sites for selected company
                        if (student.companyId) {
                            loadSitesByCompany(student.companyId, student.siteId);
                        }

                        // Populate grades dropdown
                        $.each(response.grades, function(index, grade) {
                            var selected = grade.gradeId === student.currentGradeId ? 'selected' : '';
                            $('#currentGradeId').append($('<option ' + selected + '></option>').val(grade.gradeId).text(grade.gradeName));
                        });

                        // Populate teachers dropdown
                        $.each(response.teachers, function(index, teacher) {
                            var selected = teacher.teacherId === student.assignedTeacherId ? 'selected' : '';
                            $('#assignedTeacherId').append($('<option ' + selected + '></option>').val(teacher.teacherId).text(teacher.teacherName));
                        });

                        $('#studentModal').modal('show');
                    } else {
                        KMSI.showToast(response.message || 'Failed to load student data', 'error');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Edit form data request failed:', xhr, status, error);
                    KMSI.showToast('Failed to load student data', 'error');
                });
        }

        function loadSitesByCompany(companyId, selectedSiteId) {
            if (!companyId) {
                $('#siteId').html('<option value="">Select Site</option>');
                return;
            }

            $.get(KMSI.Config.buildUrl('/Student/GetSitesByCompany?companyId=' + companyId))
                .done(function(response) {
                    if (response.success) {
                        $('#siteId').html('<option value="">Select Site</option>');
                        $.each(response.sites, function(index, site) {
                            var selected = selectedSiteId && site.siteId === selectedSiteId ? 'selected' : '';
                            $('#siteId').append($('<option ' + selected + '></option>').val(site.siteId).text(site.siteName));
                        });
                    } else {
                        KMSI.showToast(response.message || 'Unknown error', 'error');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Sites request failed:', xhr, status, error);
                    KMSI.showToast('Failed to load sites', 'error');
                });
        }

        function viewDetails(id) {
            $.get(KMSI.Config.buildUrl('/Student/Details/' + id))
                .done(function(response) {
                    if (response.success) {
                        var student = response.data;
                        var detailsHtml = `
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr><td><strong>Student Code:</strong></td><td>${student.studentCode}</td></tr>
                                        <tr><td><strong>Full Name:</strong></td><td>${student.fullName}</td></tr>
                                        <tr><td><strong>Date of Birth:</strong></td><td>${student.dateOfBirth ? new Date(student.dateOfBirth).toLocaleDateString() : 'Not specified'}</td></tr>
                                        <tr><td><strong>Age:</strong></td><td>${student.age || 'Not specified'}</td></tr>
                                        <tr><td><strong>Gender:</strong></td><td>${student.genderDisplay}</td></tr>
                                        <tr><td><strong>Registration Date:</strong></td><td>${new Date(student.registrationDate).toLocaleDateString()}</td></tr>
                                        <tr><td><strong>Status:</strong></td><td><span class="badge bg-${student.isActive ? 'success' : 'danger'}">${student.status}</span></td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr><td><strong>Company:</strong></td><td>${student.companyName}</td></tr>
                                        <tr><td><strong>Site:</strong></td><td>${student.siteName}</td></tr>
                                        <tr><td><strong>Current Grade:</strong></td><td>${student.currentGradeName || 'Not assigned'}</td></tr>
                                        <tr><td><strong>Assigned Teacher:</strong></td><td>${student.assignedTeacherName || 'Not assigned'}</td></tr>
                                        <tr><td><strong>Phone:</strong></td><td>${student.phone || 'Not specified'}</td></tr>
                                        <tr><td><strong>Email:</strong></td><td>${student.email || 'Not specified'}</td></tr>
                                        <tr><td><strong>Parent Email:</strong></td><td>${student.parentEmail || 'Not specified'}</td></tr>
                                        <tr><td><strong>Notes:</strong></td><td>${student.notes || 'No notes'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        `;
                        $('#detailsContent').html(detailsHtml);
                        $('#detailsModal').modal('show');
                    } else {
                        KMSI.showToast(response.message || 'Failed to load student details', 'error');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Details request failed:', xhr, status, error);
                    KMSI.showToast('Failed to load student details', 'error');
                });
        }

        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                $.post(KMSI.Config.buildUrl('/Student/Delete'), { id: id })
                    .done(function(response) {
                        if (response.success) {
                            KMSI.showToast(response.message || 'Student deleted successfully!', 'success');
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            KMSI.showToast(response.message || 'Failed to delete student', 'error');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Delete request failed:', xhr, status, error);
                        KMSI.showToast('Failed to delete student', 'error');
                    });
            }
        }

        // Initialize when document is ready
        $(document).ready(function() {
            try {
                KMSI.Student.init();
                console.log('KMSI Student module initialized successfully');
            } catch (error) {
                console.error('Error initializing KMSI Student module:', error);
                KMSI.showToast('Some features may not work properly. Please refresh the page.', 'warning');
            }
        });
    </script>
}